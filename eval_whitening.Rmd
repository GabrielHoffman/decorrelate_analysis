---
title: "Evaluate performance of whitening transform"
subtitle: 'Run on SNPs from 1000 Genomes project'
author: "Developed by [Gabriel Hoffman](http://gabrielhoffman.github.io/)"
date: "Run on `r Sys.time()`"
output: 
  html_document:
    toc: true
    smart: true
params:
  DATASET: NULL
---


<!--- 

cd /hpc/users/hoffmg01/work/decorrelate_analysis

git pull 
R

system("git pull"); rmarkdown::render("eval_whitening.Rmd")



# https://hoffmg01.hpc.mssm.edu/decorrelate_analysis


--->


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  dev = c("png", "pdf"),
  package.startup.message = FALSE,
  cache = FALSE,
  cache.lazy = TRUE)
```


```{r load.packages, cache=FALSE}
suppressPackageStartupMessages({
library(ggplot2)
library(tidyverse)
})
```

```{r all, fig.width=12, fig.height=8, cache=FALSE}
colMethods = c("GIW-EB (current work)" = "#E41A1C",
              "Ledoit-Wolf" = "#FF7F00", 
              "OAS"= "#cccc29", 
              "Touloumis" = "#A65628", 
              "SchÃ¤fer-Strimmer" = "#f569b3", 
              "Pseudoinverse" = "green3",                
              "lambda = 0" = "navy", 
              "lambda = 0.1" = "#377EB8", 
              "lambda = 1e-4" = "#37b8b2",              
              "Baseline" = "grey50",
              "Oracle" = "black")

df = lapply(c("EUR", "AFR", "ASN"), function(pop){
	file = paste0("df_", pop, ".RDS")
	readRDS(file) %>%
		as_tibble %>%
		mutate(pop = pop)%>%
		rename(Method = method)
})
df = bind_rows(df)
df$Method = factor(df$Method, names(colMethods))


breaks = c(0, 1500, 3000, 5000, 7000, Inf)

df %>% 
	mutate(category = cut(nsnps, breaks = breaks)) %>%
	filter(method == "0") %>%
	ggplot(aes(category)) + 
		geom_bar() +
		theme_classic()  +
		theme(aspect.ratio=1, 
			plot.title = element_text(hjust = 0.5),
			legend.position="none") +
		facet_wrap(~pop) +
		coord_flip()

df %>%
	mutate(rel.err = rMSE / rMSE_baseline) %>%
	mutate(category = cut(nsnps, breaks = breaks)) %>%
	group_by(Method) %>%
	ggplot(aes(Method, rel.err*100, fill=Method)) + 
		geom_violin() +
		geom_boxplot(width=0.1) +
		theme_classic()  +
		theme(aspect.ratio=1, 
			plot.title = element_text(hjust = 0.5),
			legend.position="none") +
		facet_grid(pop ~ category, scales="free") +
		ylab("Relative reduction in rMSE (%)") +
		coord_flip(ylim=c(0, NA)) + 
		scale_fill_manual(name="Method",values = colMethods)
```

```{r test, eval=FALSE}
a = df %>%
	mutate(rel.err = rMSE ) %>%
	mutate(category = cut(nsnps, breaks = breaks)) %>%
	group_by(Method, category, pop) %>%
	summarize(mean = mean(100*rel.err), 
		se = sd(100*rel.err) / sqrt(length(rel.err)),
		lambda = mean(lambda)) %>%
	arrange(category) %>%
	filter( pop == "ASN") 
	# filter(category == "(300,500]", pop == "ASN") 

df %>% 
	mutate(category = cut(nsnps, breaks = breaks)) %>%
	filter(Method == "GIW-EB (current work)") %>%
	ggplot(aes(category, lambda)) +
		geom_boxplot() +
		scale_y_log10() + 
		coord_flip() +
		theme_classic()  +
		theme(aspect.ratio=1, 
			plot.title = element_text(hjust = 0.5),
			legend.position="none")
```


```{r all.mean, fig.width=12, fig.height=8, cache=FALSE}
cutoff = 85

df2 = df %>%
	mutate(rel.err = rMSE / rMSE_baseline ) %>%
	mutate(category = cut(nsnps, breaks = breaks)) %>%
	group_by(Method, category, pop) %>%
	summarize(mean = mean(100*rel.err), se = sd(100*rel.err) / sqrt(length(rel.err))) %>%
	mutate(meanValue = mean, 
				mean = pmin(mean, cutoff), 
		  	se = ifelse(mean<cutoff,se,0)) 

df2 %>%
	ggplot(aes(Method, mean, fill=Method)) + 
		geom_bar(stat="identity") +
		geom_errorbar(aes(ymin = mean - 1.96*se, ymax=mean + 1.96*se), width=0) +
		geom_text(data=filter(df2, mean == cutoff), aes(method, cutoff*.9, label=round(meanValue, digits=1))) +
		theme_classic()  +
		theme(aspect.ratio=1, 
			plot.title = element_text(hjust = 0.5),
			legend.position="none") +
		facet_grid(pop ~ category) +
		ylab("Relative reduction in rMSE (%)") +
		coord_flip(expand=FALSE, ylim=c(0, cutoff) ) + 
		scale_fill_manual(name="Method",values = colMethods)
```


```{r compare, cache=FALSE, eval=FALSE}
library(rstatix)

df %>% 
	mutate(rel.err = rMSE / rMSE_baseline ) %>%
	mutate(category = cut(nsnps, breaks = breaks)) %>%
	select(Method, pop, category, rel.err) %>%
	filter(pop == "EUR", category == "(0,3e+03]") %>% 
	select(Method, rel.err) %>%
  pairwise_wilcox_test(rel.err ~ Method, p.adjust.method="bonf")
```




```{r all.curve, fig.width=12, fig.height=6, cache=FALSE}
df %>%
	mutate(rel.err = rMSE / rMSE_baseline) %>%
	mutate(category = cut(nsnps, breaks = breaks)) %>%
	group_by(Method) %>%
	ggplot(aes(nsnps, rel.err*100, color=Method)) + 
		geom_smooth(aes(fill=Method), alpha = .1) + 
		theme_classic()  +
		theme(aspect.ratio=1, 
			plot.title = element_text(hjust = 0.5)) +
		scale_x_log10() +
		ylab("Relative reduction in rMSE (%)") +
		facet_wrap( ~ pop) +
		coord_fixed(ylim=c(0, 100), xlim=c(140, 20000), expand=FALSE )  + 
		scale_color_manual(name="Method",values = colMethods)
		scale_fill_manual(name="Method",values = colMethods)
```

```{r number.of.snps}
a = df %>% 
	filter(nsnps > 10000) %>% 
	select(chrom, start, nsnps) %>% 
	distinct %>%
	nrow
```




```{r exit}
knitr::knit_exit()
```



```{r read.data}
df = readRDS("df_EUR.RDS")
```

```{r plots, cache=FALSE}
df %>%
	mutate(rel.err = (rMSE_baseline - rMSE) / rMSE_baseline) %>%
	filter(method != "0") %>%
	filter(method != "Touloumis") %>%
	group_by(method) %>%
	ggplot(aes(method, rel.err)) + 
	geom_boxplot() +
	theme_classic() +
	theme(aspect.ratio=1) +
	ylab("Relative reduction in rMSE") +
	scale_y_continuous(limits=c(0, NA))


df %>%
	mutate(rel.err = (rMSE_baseline - rMSE) / rMSE_baseline) %>%
	mutate(category = cut(nsnps, breaks = c(0, 100, 200, 500, 1000, 2000, 5000, Inf))) %>%
	filter(method != "0") %>%
	filter(method != "Touloumis") %>%
	group_by(method) %>%
	ggplot(aes(method, rel.err*100, color=method)) + 
		geom_boxplot() +
		theme_classic()  +
		facet_wrap(~category) +
		theme(aspect.ratio=1) +
		ylab("Relative reduction in rMSE (%)") +
		scale_y_continuous(limits=c(0, NA))


df %>%
	group_by(method) %>%
	summarize(mean = mean(rMSE/rMSE_baseline), 
		sem  = sd(rMSE/rMSE_baseline) / length(rMSE)) %>%
	ggplot(aes(method, mean)) + 
	geom_bar(stat="identity") +
	geom_errorbar(aes(ymin = mean - 1.96*sem, ymax = mean + 1.96*sem), width=.1, color="red") +
	theme_classic() +
	theme(aspect.ratio=1)


df %>%
	mutate(rel.err = (rMSE_baseline - rMSE) / rMSE_baseline) %>%
	group_by(method) %>%
	summarize(mean = mean(rel.err), 
		sem  = sd(rel.err) / length(rMSE)) %>%
	filter(method != "0") %>%
	filter(method != "Touloumis") %>%
	ggplot(aes(method, mean)) + 
	geom_bar(stat="identity") +
	geom_errorbar(aes(ymin = mean - 1.96*sem, ymax = mean + 1.96*sem), width=.1, color="red") +
	theme_classic() +
	theme(aspect.ratio=1)

df %>%
	mutate(rel.err = (rMSE_baseline - rMSE) / rMSE_baseline) %>%
	mutate(category = cut(df$nsnps, breaks = c(0, 1000, 2000, 5000, 10000, Inf))) %>%
	group_by(method, category) %>%
	summarize(mean = mean(rel.err), 
		sem  = sd(rel.err) / length(rMSE)) %>%
	filter(method != "0") %>%
	# filter(method != "Touloumis") %>%
	ggplot(aes(method, mean)) + 
	geom_bar(stat="identity") +
	geom_errorbar(aes(ymin = mean - 1.96*sem, ymax = mean + 1.96*sem), width=.1, color="red") +
	theme_classic() +
	facet_wrap(~category) + 
	theme(aspect.ratio=1) +
	ylab("Relative reduction in rMSE")
```
















