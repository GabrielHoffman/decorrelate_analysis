---
title: "Evaluate performance of whitening transform"
subtitle: 'Run on SNPs from 1000 Genomes project'
author: "Developed by [Gabriel Hoffman](http://gabrielhoffman.github.io/)"
date: "Run on `r Sys.time()`"
output: 
  html_document:
    toc: true
    smart: true
params:
  DATASET: NULL
---


<!--- 

cd /hpc/users/hoffmg01/work/decorrelate_analysis

git pull 
R

system("git pull"); rmarkdown::render("eval_whitening.Rmd")



# https://hoffmg01.hpc.mssm.edu/decorrelate_analysis


--->


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  dev = c("png", "pdf"),
  package.startup.message = FALSE,
  cache = FALSE,
  cache.lazy = TRUE)
```


```{r load.packages, cache=FALSE}
suppressPackageStartupMessages({
library(ggplot2)
library(tidyverse)
})
```

```{r all, fig.width=12, fig.height=8, cache=FALSE}
# , "AFR",
df = lapply(c("EUR", "ASN"), function(pop){
	file = paste0("df_", pop, ".RDS")
	readRDS(file) %>%
		as_tibble %>%
		mutate(pop = pop)
})
df = bind_rows(df)

cols = c(RColorBrewer::brewer.pal(length(unique(df$method))-1, "Set1"), "black")

cols[cols == "#FFFF33"]= "#cccc29"

df %>%
	mutate(rel.err = rMSE / rMSE_baseline) %>%
	mutate(category = cut(nsnps, breaks = c(0, 300, 500, 700, 1000, 2500, Inf))) %>%
	group_by(method) %>%
	ggplot(aes(method, rel.err*100, fill=method)) + 
		geom_violin() +
		geom_boxplot(width=0.1) +
		theme_classic()  +
		theme(aspect.ratio=1, 
			plot.title = element_text(hjust = 0.5),
			legend.position="none") +
		facet_grid(pop ~ category, scales="free") +
		theme(aspect.ratio=1) +
		ylab("Relative reduction in rMSE (%)") +
		coord_flip(ylim=c(0, 120)) + 
		scale_fill_manual(name="Method",values = cols)
```




```{r all.mean, fig.width=12, fig.height=8, cache=FALSE}
df2 = df %>%
	mutate(rel.err = rMSE ) %>%
	mutate(category = cut(nsnps, breaks = c(0, 300, 500, 700, 1000, 2500, Inf))) %>%
	group_by(method, category, pop) %>%
	summarize(mean = mean(100*rel.err), se = sd(100*rel.err) / sqrt(length(rel.err))) %>%
	mutate(meanValue = mean, 
				mean = pmin(mean, 60), 
		  	se = ifelse(mean<60,se,0)) 

df2 %>%
	ggplot(aes(method, mean, fill=method)) + 
		geom_bar(stat="identity") +
		geom_errorbar(aes(ymin = mean - 1.96*se, ymax=mean + 1.96*se), width=0) +
		geom_text(data=filter(df2, mean == 60), aes(method, 47, label=round(meanValue, digits=1))) +
		theme_classic()  +
		theme(aspect.ratio=1, 
			plot.title = element_text(hjust = 0.5),
			legend.position="none") +
		facet_grid(pop ~ category) +
		theme(aspect.ratio=1) +
		ylab("Relative reduction in rMSE (%)") +
		coord_flip(expand=FALSE, ylim=c(0, 60) ) + 
		scale_fill_manual(name="Method",values = cols)
```



```{r all.curve, fig.width=12, fig.height=6, cache=FALSE}
df %>%
	mutate(rel.err = rMSE ) %>%
	mutate(category = cut(nsnps, breaks = c(0, 300, 500, 700, 1000, 2500, Inf))) %>%
	group_by(method) %>%
	ggplot(aes(nsnps, rel.err*100, color=method)) + 
		geom_smooth(aes(fill=method), alpha = .1) + 
		theme_classic()  +
		theme(aspect.ratio=1, 
			plot.title = element_text(hjust = 0.5)) +
		theme(aspect.ratio=1) +
		scale_x_log10() +
		ylab("Relative reduction in rMSE (%)") +
		facet_wrap( ~ pop) +
		coord_fixed(ylim=c(0, 100), xlim=c(140, 20000), expand=FALSE )  + 
		scale_color_manual(name="Method",values = cols) + 
		scale_fill_manual(name="Method",values = cols) 
```

```{r number.of.snps}
a = df %>% 
	filter(nsnps > 10000) %>% 
	select(chrom, start, nsnps) %>% 
	distinct %>%
	nrow
```




```{r exit}
knitr::knit_exit()
```



```{r read.data}
df = readRDS("df_EUR.RDS")
```

```{r plots, cache=FALSE}
df %>%
	mutate(rel.err = (rMSE_baseline - rMSE) / rMSE_baseline) %>%
	filter(method != "0") %>%
	filter(method != "Touloumis") %>%
	group_by(method) %>%
	ggplot(aes(method, rel.err)) + 
	geom_boxplot() +
	theme_classic() +
	theme(aspect.ratio=1) +
	ylab("Relative reduction in rMSE") +
	scale_y_continuous(limits=c(0, NA))


df %>%
	mutate(rel.err = (rMSE_baseline - rMSE) / rMSE_baseline) %>%
	mutate(category = cut(nsnps, breaks = c(0, 100, 200, 500, 1000, 2000, 5000, Inf))) %>%
	filter(method != "0") %>%
	filter(method != "Touloumis") %>%
	group_by(method) %>%
	ggplot(aes(method, rel.err*100, color=method)) + 
		geom_boxplot() +
		theme_classic()  +
		facet_wrap(~category) +
		theme(aspect.ratio=1) +
		ylab("Relative reduction in rMSE (%)") +
		scale_y_continuous(limits=c(0, NA))


df %>%
	group_by(method) %>%
	summarize(mean = mean(rMSE/rMSE_baseline), 
		sem  = sd(rMSE/rMSE_baseline) / length(rMSE)) %>%
	ggplot(aes(method, mean)) + 
	geom_bar(stat="identity") +
	geom_errorbar(aes(ymin = mean - 1.96*sem, ymax = mean + 1.96*sem), width=.1, color="red") +
	theme_classic() +
	theme(aspect.ratio=1)


df %>%
	mutate(rel.err = (rMSE_baseline - rMSE) / rMSE_baseline) %>%
	group_by(method) %>%
	summarize(mean = mean(rel.err), 
		sem  = sd(rel.err) / length(rMSE)) %>%
	filter(method != "0") %>%
	filter(method != "Touloumis") %>%
	ggplot(aes(method, mean)) + 
	geom_bar(stat="identity") +
	geom_errorbar(aes(ymin = mean - 1.96*sem, ymax = mean + 1.96*sem), width=.1, color="red") +
	theme_classic() +
	theme(aspect.ratio=1)

df %>%
	mutate(rel.err = (rMSE_baseline - rMSE) / rMSE_baseline) %>%
	mutate(category = cut(df$nsnps, breaks = c(0, 1000, 2000, 5000, 10000, Inf))) %>%
	group_by(method, category) %>%
	summarize(mean = mean(rel.err), 
		sem  = sd(rel.err) / length(rMSE)) %>%
	filter(method != "0") %>%
	# filter(method != "Touloumis") %>%
	ggplot(aes(method, mean)) + 
	geom_bar(stat="identity") +
	geom_errorbar(aes(ymin = mean - 1.96*sem, ymax = mean + 1.96*sem), width=.1, color="red") +
	theme_classic() +
	facet_wrap(~category) + 
	theme(aspect.ratio=1) +
	ylab("Relative reduction in rMSE")
```
















